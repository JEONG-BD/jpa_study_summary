# 15장 고급주제와 성능 최적화

## 15.1 예외처리 
### 15.1.1 JPA표준 예외 정리 
- JPA 표준 예외들은 javax.persistence.PersistenceException의 자식 클래스이며 이 예외는 RuntimeException의 자식이다. 따라서 JPA는 모두 언체크 예외이다. 
- JPA의 예외는 트랜잭션 롤백을 표시하는 예외와 표시하지 하는 예외로 나뉜다. 
- 트랜잭션을 롤백하는 예외는 심각한 예외 이므로 복구해서는 안되는 반면에 트랜잭션 롤백을 표시하지 않는 예외는 심각한 예외가 아니다. 

### 15.1.2 스프링 프레임워크의 JPA예외 변환 
- 서비스 계층에서 데이터 접근 계층의 구현 기술에 직접 의존하는 것은 좋은 설계라 할 수 없다. 
- 서비스 계층에서 JPA의 예외를 직접 사용하면 JPA에 의존하게 된다. 
- 스프링 프레임워크에서는 이러한 문제를 해결하기 위해서 데이터 접근 계층에 대한 예외를  추상화 해서 개발자에게 제공한다. 

### 15.1.3 스프링 프레임워크에 JPA예외 변환기 적용 
- JPA예외를 스프링 프레임워크가 제공하는 추상화된 예외로 변경하려면 PersistenceExceptionTranslationPostProcessor를 스프링 빈으로 등록하면 된다. 


### 15.1.4 트랜잭션 롤백 시 주의 사랑 
- 트랜잭션을 롤백하는 것은 데이터베이스의 반영사항을 롤백하는 것이지 수정한 자바 객체까지 원상태로 복구해 주지 않는다. 
- 트랜잭션이 롤백된 영속성 컨텍스트를 그대로 사용하는 것은 위험하기 때문에 새로운 영속성 컨텍스트를 생성해서 사용하거나 clear()를 호출해서 영속성 컨텍스트를 초기화한 다음에 사용해야 한다. 
- 스프링 프레임워크는 영속성 컨텍스트의 범위에 따라 다른 방법을 사용한다. 
- 기본전략인 트랜잭션당 영속성 컨텍스트 전략은 문제가 발생하면 트랜잭션 AOP종료 시점에 트랜잭션을 롤백하면서 영속성 컨텍스트로 함께 종료하므로 문제가 발생하지 않는다. 
- OSIV처럼 영속성 컨텍스트의 범위를 트랜잭션 보다 넓게 사용해서 여러 트랜잭션이 하나의 영속성 컨텍스트를 사용할 때 발생하는데 스프링 프레임워크는 영속성 컨텍스트의 범위를 넓게 설정하면 영속성 컨텍스트를 초기화해서 잘못된 영속성 컨텍스트를 사용하는 문제를 해결한다. 


